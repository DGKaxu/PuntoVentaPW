{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block content %}

<div id="MaterialesModal" class="modal bd-example-modal-lg" style="overflow: scroll;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info">
                <h3 class="modal-title text-dark">Agregar Material</h3>
            </div>
            <div class="modal-body" style="overflow:scroll; max-height: 450px;">
                <table class="table table-hover tabla-redondeada">
                    <thead>
                        <tr>
                            <th># ID</th>
                            <th>Descripción</th>
                            <th>Precio</th>
                            <th>Agregar</th>
                        </tr>
                    </thead>
                    <tbody class="text-dark">
                        {% for i in productos_lista %}
                        <tr>
                            <td>{{i.id}}</td>
                            <td>{{i.descripcion}}</td>
                            <td>$ {{i.precio}}</td>
                            <td>
                                <button onclick="addProductList('{{i.id}}', '{{i.descripcion|escapejs}}','{{i.precio}}')"
                                    class="btn btn-success" data-dismiss="modal" type="button">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="modal-footer bg-dark">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div id="ClientesModal" class="modal bd-example-modal-lg" style="overflow: scroll;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info">
                <h3 class="modal-title text-dark">Seleccionar Cliente</h3>
            </div>
            <div class="modal-body" style="overflow:scroll; max-height: 450px;">
                <input type="text" id="filtroClientes" class="form-control mb-2" placeholder="Buscar cliente..." onkeyup="filtrarClientes()">
                
                <table class="table table-hover tabla-redondeada" id="tablaClientesModal">
                    <thead>
                        <tr>
                            <th># ID</th>
                            <th>Nombre</th>
                            <th>Telefono</th>
                            <th>Seleccionar</th>
                        </tr>
                    </thead>
                    <tbody class="text-dark">
                        {% for i in clientes_lista %}
                        <tr>
                            <td>{{i.id}}</td>
                            <td>{{i.nombre}}</td>
                            <td>{{i.telefono}}</td>
                            <td>
                                <button onclick="seleccionarCliente('{{i.id}}', '{{i.nombre|escapejs}}')" class="btn btn-success"
                                    data-dismiss="modal" type="button">
                                    <i class="fas fa-check"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="modal-footer bg-dark">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div id="ConfirmacionModal" class="modal bd-example-modal-lg">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info">
                <h3 class="modal-title text-dark">Confirmar Pago</h3>
            </div>
            <div class="modal-body">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Método</th>
                            <th>Monto {{moneda}}</th>
                        </tr>
                    </thead>
                    <tbody class="text-dark">
                        <tr><td>Efectivo:</td><td><input type="number" class="form-control" id="efectivo" value="0.00"></td></tr>
                        <tr><td>Tarjeta:</td><td><input type="number" class="form-control" id="tarjeta" value="0.00"></td></tr>
                        <tr><td>Transferencia:</td><td><input type="number" class="form-control" id="transferencia" value="0.00"></td></tr>
                        <tr><td>Vales:</td><td><input type="number" class="form-control" id="vales" value="0.00"></td></tr>
                        <tr><td>Otro:</td><td><input type="number" class="form-control" id="otro" value="0.00"></td></tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer bg-dark">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Cancelar</button>
                <button onclick="saveData()" id="btn" class="btn btn-success btn-lg">Terminar Venta <i class="fas fa-money-bill"></i></button>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-4">
        <label>Impresión:</label>
        <select required name="impresion" class="form-control" id="impresion">
            <option value="1" selected>Ticket</option>
            <option value="2">Nota de venta</option>
        </select>
    </div>
    <div class="col-md-4">
        <label>Fecha:</label>
        <input required type="date" class="form-control" name="fecha" id="fecha" value="{{HOY}}">
    </div>
    <div class="col-md-4">
        <label>¿Desglosar IVA?</label>
        <div class="input-group">
            <div class="input-group-prepend">
                <div class="input-group-text">
                    <input type="checkbox" id="desglosar">
                </div>
            </div>
            <input type="text" class="form-control" value="Sí, desglosar IVA" disabled>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-12">
        <label>Cliente:</label>
        <div class="input-group">
            <input type="hidden" name="id_cliente" id="id_cliente" value="1">
            <input type="text" class="form-control" value="{{cliente.nombre}}" id="cliente" readonly>
            <div class="input-group-append">
                <button class="btn btn-primary" data-toggle="modal" data-target="#ClientesModal">
                    <i class="fas fa-user-edit"></i> Buscar
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="input-group">
            <div class="input-group-prepend"><span class="input-group-text">Producto:</span></div>
            
            <input type="text" class="form-control" placeholder="Escribe o escanea código..." id="search" list="lista-productos" autocomplete="off">
            
            <datalist id="lista-productos">
                {% for i in productos_lista %}
                    <option value="{{i.descripcion}}" data-id="{{i.id}}" data-precio="{{i.precio}}">{{i.codigo}}</option>
                {% endfor %}
            </datalist>

            <div class="input-group-append">
                <button onclick="borrarContent()" class="btn btn-danger" type="button"><i class="fas fa-times"></i></button>
                <button class="btn btn-primary" data-toggle="modal" data-target="#MaterialesModal"><i class="fas fa-list"></i></button>
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body p-0" style="height: 300px; overflow-y: scroll;">
                <table class="table table-striped text-center" id="tableProducts">
                    <thead class="bg-secondary text-white">
                        <tr>
                            <th>Quitar</th>
                            <th>Descripción</th>
                            <th width="15%">Cant.</th>
                            <th width="15%">Precio</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody class="text-dark">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="row mt-2">
    <div class="col-12 text-right">
        <h3 class="font-weight-bold text-success" id="total">Total: $0.00</h3>
    </div>
</div>

<div class="row mt-3">
    <div class="col-12">
        <button data-toggle="modal" data-target="#ConfirmacionModal" class="btn btn-success btn-lg btn-block">
            COBRAR VENTA <i class="fas fa-money-bill-wave"></i>
        </button>
    </div>
</div>

<div class="row mt-3 mb-5">
    <div class="col-md-12">
        <label>Comentarios:</label>
        <textarea class="form-control" id="comentarios" rows="2"></textarea>
    </div>
</div>

<script>
    var verts = {
        items: {
            total: 0.00,
            products: []
        },
        // Calcula totales
        calculate: function () {
            var calculatedtotal = 0;
            $.each(this.items.products, function (pos, dict) {
                calculatedtotal += parseFloat(dict.subtotal);
            });
            this.items.total = calculatedtotal;
            document.getElementById("total").innerHTML = "Total: $" + parseFloat(this.items.total).toFixed(2);
        },

        list: function () {
            var tbody = $("#tableProducts tbody");
            tbody.empty();
            
            $.each(this.items.products, function (pos, dict) {
                var fila = `<tr>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="verts.borrar(${pos})"><i class="fas fa-trash"></i></button>
                    </td>
                    <td>${dict.descripcion}</td>
                    <td>
                        <input type="number" class="form-control form-control-sm text-center" 
                               value="${dict.cantidad}" onchange="verts.cambiarCantidad(${pos}, this.value)">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm text-center" 
                               value="${dict.precio}" onchange="verts.cambiarPrecio(${pos}, this.value)">
                    </td>
                    <td>$${parseFloat(dict.subtotal).toFixed(2)}</td>
                </tr>`;
                tbody.append(fila);
            });
        },
        borrar: function(index) {
            this.items.products.splice(index, 1);
            this.list();
            this.calculate();
        },
        cambiarCantidad: function(index, val) {
            var cant = parseInt(val);
            if (isNaN(cant) || cant < 1) cant = 1;
            this.items.products[index].cantidad = cant;
            this.items.products[index].subtotal = this.items.products[index].precio * cant;
            this.calculate();
            this.list();
        },
        cambiarPrecio: function(index, val) {
            var precio = parseFloat(val);
            if (isNaN(precio) || precio < 0) precio = 0;
            this.items.products[index].precio = precio;
            this.items.products[index].subtotal = this.items.products[index].cantidad * precio;
            this.calculate();
            this.list();
        }
    };

    document.getElementById('search').addEventListener('input', function() {
        var valor = this.value;
        var lista = document.getElementById('lista-productos');
        var opciones = lista.options;

        for (var i = 0; i < opciones.length; i++) {
            if (opciones[i].value === valor) {
                var id = opciones[i].getAttribute('data-id');
                var precio = opciones[i].getAttribute('data-precio');
                var desc = opciones[i].value;

                addProductList(id, desc, precio);
                this.value = "";
                break;
            }
        }
    });

    function addProductList(id, descripcion, precio) {
        // Sumar cantidad
        var existente = verts.items.products.find(p => p.id == id);
        if(existente){
            existente.cantidad++;
            existente.subtotal = existente.cantidad * existente.precio;
        } else {
            verts.items.products.push({
                id: id,
                descripcion: descripcion,
                cantidad: 1,
                precio: parseFloat(precio),
                subtotal: parseFloat(precio)
            });
        }
        verts.list();
        verts.calculate();
    }

    function seleccionarCliente(id, nombre) {
        document.getElementById("id_cliente").value = id;
        document.getElementById("cliente").value = nombre;
    }

    function borrarContent() {
        document.getElementById("search").value = "";
    }

    function activarEspera() {
        var btn = document.getElementById("btn");
        if(btn) { btn.disabled = true; btn.innerHTML = 'Procesando...'; }
    }
    
    function desactivarEspera() {
        var btn = document.getElementById("btn");
        if(btn) { btn.disabled = false; btn.innerHTML = 'Terminar Venta <i class="fas fa-money-bill"></i>'; }
    }

    //Buscador tabla clientes modal
    function filtrarClientes() {
        var input = document.getElementById("filtroClientes");
        var filtro = input.value.toUpperCase();
        var tabla = document.getElementById("tablaClientesModal");
        var tr = tabla.getElementsByTagName("tr");
        for (var i = 0; i < tr.length; i++) {
            var td = tr[i].getElementsByTagName("td")[1];
            if (td) {
                var txtValue = td.textContent || td.innerText;
                if (txtValue.toUpperCase().indexOf(filtro) > -1) { tr[i].style.display = ""; } 
                else { tr[i].style.display = "none"; }
            }
        }
    }

    //GUARDAR VENTA
    function saveData() {
        // Validaciones Locales
        if (verts.items.products.length === 0) {
            alert("Error: El carrito está vacío");
            return;
        }
        if (document.getElementById("id_cliente").value == '') {
            return;
        }

        // Validación Pagos
        var efectivo = parseFloat(document.getElementById("efectivo").value) || 0;
        var tarjeta = parseFloat(document.getElementById("tarjeta").value) || 0;
        var transf = parseFloat(document.getElementById("transferencia").value) || 0;
        var vales = parseFloat(document.getElementById("vales").value) || 0;
        var otro = parseFloat(document.getElementById("otro").value) || 0;
        var total_pagado = efectivo + tarjeta + transf + vales + otro;
        
        if (total_pagado < (verts.items.total - 0.1)) {
            alert('Pago Insuficiente: Faltan $' + (verts.items.total - total_pagado).toFixed(2));
            return;
        }

        activarEspera();

        $.ajax({
            url: "{% url 'AddVenta' %}",
            type: 'POST',
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                'action': 'save',
                'fecha': document.getElementById("fecha").value,
                'id_cliente': document.getElementById("id_cliente").value,
                'cliente': document.getElementById("cliente").value,
                'comentarios': document.getElementById("comentarios").value,
                'ticket': document.getElementById("impresion").value,
                'desglosar': document.getElementById('desglosar').checked ? 1 : 0,
                'efectivo': efectivo, 'tarjeta': tarjeta, 'transferencia': transf, 'vales': vales, 'otro': otro,
                'verts': JSON.stringify(verts.items)
            },
            dataType: 'json',
        }).done(function (data) {
            if (data.error) {
                alert('Error: ' + data.error);
                desactivarEspera();
            } else {
                window.open("{% url 'ExportPDF' 0 0 %}".replace('0/0', data[0] + '/' + data[2]), '_blank');
                location.reload();
            }
        }).fail(function (jqXHR, textStatus) {
            alert('Error Crítico: ' + textStatus);
            desactivarEspera();
        });
    }
</script>

{% if messages %}
    {% for message in messages %}
    <script>Swal.fire('Aviso', '{{message}}', 'success')</script>
    {% endfor %}
{% endif %}

{% endblock %}